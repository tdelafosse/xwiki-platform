<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>SignedScripts</web>
  <name>MigrationScript</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>SignedScripts.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1378831652000</creationDate>
  <date>1379008566000</date>
  <contentUpdateDate>1379008566000</contentUpdateDate>
  <version>1.1</version>
  <title>MigrationScript</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>This page is made to make the transition from the former PR system to the new one : it enables you to sign old pages / objects with the new system.

{{velocity}}
##
## Macro for signing the content of a given document
##
#macro(signContent $document)
  #set($newLine = $util.getNewline()) 
  #set($id = 'allContent')
  #set($signatureClass = 'SignedScripts.SignatureClass')
  #set($user = $context.getUser().toString())
  #set($targetDoc = $xwiki.getDocument($document))
  #set($content = $targetDoc.getContent())
  #set($newContent = "{{sign id='$id'}}"+ $newLine + $content + $newLine + "{{/sign}}")
  #set($signature = $services.signedScripts.computeSignature("$content", 'test'))
  #set($signatureObject = $targetDoc.getObject($signatureClass, "id", $id))
  #if($signatureObject)
    $services.localization.render('signedScripts.migration.failure', [$targetDoc.name])
  #else
    #set($n = $targetDoc.createNewObject($signatureClass))
    #set($signatureObject = $targetDoc.getObject($signatureClass, $n))
    #set($discard = $signatureObject.set('id', $id))
    #set($discard = $signatureObject.set('signature', $signature))
    #set($discard = $signatureObject.set('certificate', 'test'))
    #set($discard = $signatureObject.set('author', $user))
    #set($discard = $targetDoc.setContent($newContent))
    #set($discard = $targetDoc.save('Signing the content'))
    $services.localization.render('signedScripts.migration.success', [$targetDoc.name])
  #end
#end
##
## If the user specified a given page, let's sign its content
##
#if($request.document)
  #signContent($request.document)
#end
##
## If the user specified a space, let's sign the content of all the documents from this space
##
#if($request.space)
  #set($documents = $services.query.xwql("where doc.space='$request.space'").execute())
  #foreach($document in $documents)
    #signContent($document)
  #end
#end

{{html}}
&lt;form&gt;
  &lt;label&gt;$services.localization.render('signedScripts.migration.choosePage')&lt;/label&gt;
  &lt;input type="text" name="document" class="suggestDocuments withTip" value="Document Name" /&gt;
  &lt;span class='buttonwrapper'&gt;
    &lt;input type='submit' class='button' value="$services.localization.render('signedScripts.migration.signPage')"&gt;
  &lt;/span&gt;
&lt;/form&gt;
&lt;br&gt;
&lt;form&gt;
  &lt;label&gt;$services.localization.render('signedScripts.migration.chooseSpace')&lt;/label&gt;
  &lt;input type="text" name="space" class="suggestSpaces withTip" value="Space Name" /&gt;
  &lt;span class='buttonwrapper'&gt;
    &lt;input type='submit' class='button' value="$services.localization.render('signedScripts.migration.signSpace')"&gt;
  &lt;/span&gt;
&lt;/form&gt;
{{/html}}

{{/velocity}}</content>
</xwikidoc>
