<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>SignedScripts</web>
  <name>SignAllScriptsFromPage</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>SignedScripts.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1378479110000</creationDate>
  <date>1378735424000</date>
  <contentUpdateDate>1378480370000</contentUpdateDate>
  <version>1.1</version>
  <title>SignAllScriptsFromPage</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity}}
#if($request.document)
  #set($signatureClass = 'SignedScripts.SignatureClass')
  #set($user = $context.getUser().toString())
  #set($targetDoc = $xwiki.getDocument($request.document))
  #set($documentRef = $targetDoc.getDocumentReference())
  #set($scripts = $services.signedScripts.findScripts($documentRef))
  #foreach ($script in $scripts.entrySet())
    #set($id = $script.key)
    #set($content = $script.value)
    #set($signature = $services.signedScripts.computeSignature("$content", 'test'))
    #set($signatureObject = $targetDoc.getObject($signatureClass, "id", $id))
    #if(!$signatureObject)
      #set($n = $targetDoc.createNewObject($signatureClass))
      #set($signatureObject = $targetDoc.getObject($signatureClass, $n))
      $signatureObject.set('id', $id)
    #end
    #set($discard = $signatureObject.set('signature', $signature))
    #set($discard = $signatureObject.set('certificate', 'test'))
    #set($discard = $signatureObject.set('author', $user))
    #set($discard = $targetDoc.save())
    $services.localization.render('signedScripts.signAll.success')
  #end
#end
#set($allDocs = $services.query.xwql("where 1=1").execute())

{{html}}
&lt;form&gt;
  &lt;label&gt;$services.localization.render('signedScripts.signAll.chooseLabel')&lt;/label&gt;
  &lt;select name='document'&gt;
  #foreach($document in $allDocs)
    &lt;option value="$document"&gt;$document&lt;/option&gt;
  #end
  &lt;/select&gt;
  &lt;input type='submit' value="$services.localization.render('signedScripts.signAll.sign')"&gt;
&lt;/form&gt;
{{/html}}

{{/velocity}}
</content>
</xwikidoc>
